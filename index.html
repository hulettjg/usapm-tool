<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>USAPM CAP Slide Generator (v3.0)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body onload="initializeDashboard()">
    <div class="dashboard-container">
        <div class="form-panel">
            <div class="container">
                <div class="header-controls"><h1>CAP Data Entry</h1><div class="theme-switcher"><span>‚òÄÔ∏è</span><label class="switch"><input type="checkbox" id="darkModeToggle" onclick="toggleDarkMode()"><span class="slider round"></span></label><span>üåô</span></div></div>
                <form id="dataForm">
                    <input type="hidden" id="currentId"><label>Deficiency Write-up:</label><textarea id="editWriteup" rows="4"></textarea><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px"><input type="text" id="editTracking" placeholder="Tracking Number"><select id="editSeverity"><option>Minor</option><option>Significant</option><option>Critical</option></select></div>
                    <label>Point of Contact (POC):</label>
                    <input type="text" id="editPoc" placeholder="e.g., TSgt Smith">
                    <hr style="margin: 20px 0; border-color: var(--item-border);"><h3 style="margin-top: 20px;">Root Cause & Corrective Action</h3><label>1. Cause Code Category:</label><select id="editCauseCategory" onchange="populateSubcategories(this.value)"></select><label>2. Cause Code Subcategory:</label><select id="editCauseSubcategory" onchange="populateCauseCodes(this.value)"></select><label>3. Specific Cause Code:</label><select id="editCauseCode"></select><label>Complete the sentence: "To address this, the unit will..."</label><textarea id="editCapAction" rows="3" placeholder="e.g., conduct monthly seatbelt inspections..."></textarea><label>Implementation Timeframe:</label><input list="timeframe-options" id="editCapTimeframe" placeholder="e.g., 90 days"><datalist id="timeframe-options"><option value="30 days"></option><option value="60 days"></option><option value="90 days"></option><option value="6 months"></option><option value="1 year"></option></datalist><h3 style="margin-top: 20px;">Validation & Closure</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px"><input type="text" id="editValidation" placeholder="Validation Event (e.g., next exercise)"><input type="text" id="editMetric" placeholder="Success Metric (e.g., 100% compliance)"></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:15px"><div><label>Proposed Closure Action</label><input list="closure-actions" id="editClosureAction" value="request closure of"><datalist id="closure-actions"><option value="request closure of"></option></datalist></div><div><label>Closure Authority</label><input list="closure-authorities" id="editClosureAuthority" placeholder="Select or type..."><datalist id="closure-authorities"><option value="702 MXS/CC"></option><option value="2 MXG/CC"></option></datalist></div></div>
                    <button type="button" class="btn btn-save" id="saveBtn" onclick="saveDeficiency()">Save / Add New</button>
                    <button type="button" class="btn" onclick="clearForm()">Clear Form</button>
                </form>
            </div>
             <div class="container">
                <h2>Deficiency List</h2>
                <div class="filter-section">
                    <input type="text" id="filterKeyword" oninput="renderDeficiencyList()" placeholder="Filter by keyword...">
                    <select id="filterSeverity" onchange="renderDeficiencyList()"><option value="All Severities">All Severities</option><option>Minor</option><option>Significant</option><option>Critical</option></select>
                    <select id="filterStatus" onchange="renderDeficiencyList()"><option value="All">All Statuses</option><option value="New">New</option><option value="Pending">Pending</option><option value="Completed">Completed</option><option value="Revisions">Revisions Needed</option></select>
                    <select id="sortBy" onchange="renderDeficiencyList()"><option value="date-newest">Sort: Last Edited (Newest)</option><option value="date-oldest">Sort: Last Edited (Oldest)</option><option value="severity">Sort: Severity</option><option value="tracking-az">Sort: Tracking #</option></select>
                </div>
                <div id="deficiencyListContainer"></div>
            </div>
        </div>
        <div class="preview-panel">
            <div class="container">
                <h3>Live CAP Slide Preview</h3>
                <div id="slide-to-capture" class="slide">
                    <div class="slide-header" id="s_header">TRACKING NUMBER</div>
                    <div class="slide-body" id="s_body">Awaiting input...</div>
                    <div class="slide-watermark" id="s_watermark"></div>
                </div>
                <button class="btn" onclick="downloadSlide()" style="width:100%; margin-top: 20px; font-size: 1rem; background-color: #6f42c1;">Download Slide</button>
            </div>
            <div class="container">
                <h3>Admin Tools</h3>
                <button type="button" class="collapsible">General Guidance</button>
                <div class="guidance-content">
                    <h4>Table 1. Deficiencies Levied by Wing IG</h4><table><tr><th>Type</th><th>Process Step</th></tr><tr><td>Squadron Minor</td><td>Propose (OPR) -> Accept (Sq/CC) -> Implement (OPR) -> <strong>Close (Sq/CC)</strong></td></tr><tr><td>Squadron Critical/Significant</td><td>Propose (OPR/Sq CC) -> Concur (BW/IG) -> Accept (Gp/CC) -> Implement (OPR/Sq CC) -> <strong>Close (Gp/CC)</strong></td></tr><tr><td>Group (All)</td><td>Propose (OPR) -> Accept (Gp/CC) -> Implement (OPR) -> <strong>Close (Gp/CC)</strong></td></tr></table>
                    <h4>Table 2. Deficiencies Levied by AFGSC/IG</h4><table><tr><th>Type</th><th>Process Step</th></tr><tr><td>Squadron Minor</td><td>Propose (OPR/Sq CC) -> Accept (Gp/CC) -> Implement (OPR/Sq CC) -> <strong>Close (Gp/CC)</strong></td></tr><tr><td>Squadron Critical/Significant</td><td>Propose (OPR) -> Concur (Gp/CC) -> Concur (BW/IG) -> Accept (FAM) -> Implement (BW/CC) -> <strong>Close (AFGSC/IG)</strong></td></tr><tr><td>Group Minor</td><td>Propose (OPR/Gp CC) -> Accept (Gp/CC) -> Implement (OPR/Gp CC) -> <strong>Close (Gp/CC)</strong></td></tr></table>
                </div>
                <hr style="margin: 20px 0; border-color: var(--item-border);">
                <button type="button" class="collapsible">Backup & Restore</button>
                <div class="guidance-content">
                    <p>Use these tools to manually save or load your entire deficiency list.</p>
                    <button class="btn backup-btn" onclick="createBackup()">Create Backup</button>
                    <button class="btn restore-btn" onclick="restoreFromBackup()">Restore from Backup</button>
                    <textarea id="backupData" style="display: none; width: 100%; margin-top: 15px;" rows="8" readonly></textarea>
                </div>
            </div>
            <div class="container footer">
                Created by TSgt James Hulett | Version <span id="version-display"></span>
                | <a href="#" onclick="checkForUpdates(event, true)">Check for Updates</a>
            </div>
        </div>
    </div>
    <script src="script.js"></script>
</body>
</html>
